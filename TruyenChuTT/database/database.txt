-- N·∫øu ƒë√£ c√≥ database th√¨ x√≥a r·ªìi t·∫°o m·ªõi
DROP DATABASE IF EXISTS DBTruyen;
CREATE DATABASE DBTruyen CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE DBTruyen;

-- B·∫£ng Ng∆∞·ªùi d√πng
CREATE TABLE NguoiDung (
    ID INT AUTO_INCREMENT PRIMARY KEY,
    Email VARCHAR(255) UNIQUE NOT NULL,
    MatKhau VARCHAR(255) NOT NULL,
    HoTen VARCHAR(255) NOT NULL,
    SoDienThoai VARCHAR(20),
    AnhDaiDien LONGTEXT,
    VaiTro VARCHAR(20) DEFAULT 'USER',
    TrangThai BOOLEAN DEFAULT TRUE,
    NgayTao DATETIME DEFAULT CURRENT_TIMESTAMP,
    NgayCapNhat DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    TokenQuenMatKhau VARCHAR(255),
    HetHanToken DATETIME,
    TrangThaiVIP BOOLEAN DEFAULT FALSE,
    NgayDangKyVIP DATETIME NULL,
    NgayHetHanVIP DATETIME NULL,
    CHECK (VaiTro IN ('ADMIN', 'USER'))
);

-- B·∫£ng T√°c gi·∫£
CREATE TABLE TacGia (
    ID INT AUTO_INCREMENT PRIMARY KEY,
    TenTacGia VARCHAR(255) NOT NULL,
    MoTa LONGTEXT,
    AnhDaiDien LONGTEXT,
    NgayTao DATETIME DEFAULT CURRENT_TIMESTAMP
);

SELECT * FROM dbtruyen.NguoiDung;

-- B·∫£ng Th·ªÉ lo·∫°i
CREATE TABLE TheLoai (
    ID INT AUTO_INCREMENT PRIMARY KEY,
    TenTheLoai VARCHAR(255) NOT NULL,
    MoTa LONGTEXT,
    ThuTu INT DEFAULT 0,
    TrangThai BOOLEAN DEFAULT TRUE,
    MauSac VARCHAR(20)
);

-- B·∫£ng Truy·ªán
CREATE TABLE Truyen (
    ID INT AUTO_INCREMENT PRIMARY KEY,
    TenTruyen VARCHAR(500) NOT NULL,
    MoTa LONGTEXT,
    AnhBia LONGTEXT,
    TacGiaID INT,
    TrangThai VARCHAR(50) DEFAULT 'DANG_TIEN_HANH',
    ChiDanhChoVIP BOOLEAN DEFAULT FALSE,
    NoiBat BOOLEAN DEFAULT FALSE,
    TruyenMoi BOOLEAN DEFAULT FALSE,
    LuotXem INT DEFAULT 0,
    DiemDanhGia FLOAT DEFAULT 0,
    SoLuongDanhGia INT DEFAULT 0,
    NgayTao DATETIME DEFAULT CURRENT_TIMESTAMP,
    NgayCapNhat DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    NguoiTaoID INT,
    CHECK (TrangThai IN ('DANG_TIEN_HANH', 'HOAN_THANH', 'TAM_DUNG', 'DA_XOA')),
    FOREIGN KEY (TacGiaID) REFERENCES TacGia(ID),
    FOREIGN KEY (NguoiTaoID) REFERENCES NguoiDung(ID)
);

-- B·∫£ng li√™n k·∫øt Truy·ªán - Th·ªÉ lo·∫°i (Many-to-Many)
CREATE TABLE TruyenTheLoai (
    TruyenID INT,
    TheLoaiID INT,
    PRIMARY KEY (TruyenID, TheLoaiID),
    FOREIGN KEY (TruyenID) REFERENCES Truyen(ID) ON DELETE CASCADE,
    FOREIGN KEY (TheLoaiID) REFERENCES TheLoai(ID) ON DELETE CASCADE
);

-- B·∫£ng Ch∆∞∆°ng
CREATE TABLE Chuong (
    ID INT AUTO_INCREMENT PRIMARY KEY,
    TruyenID INT,
    TenChuong LONGTEXT NOT NULL,
    NoiDung LONGTEXT NOT NULL,
    SoChuong INT NOT NULL,
    ChiDanhChoVIP BOOLEAN DEFAULT FALSE,
    LuotXem INT DEFAULT 0,
    TrangThai VARCHAR(50) DEFAULT 'CONG_KHAI',
    NgayTao DATETIME DEFAULT CURRENT_TIMESTAMP,
    NgayCapNhat DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    NgayDangLich DATETIME NULL,
    CHECK (TrangThai IN ('CONG_KHAI', 'AN', 'NHAP', 'LICH_DANG')),
    FOREIGN KEY (TruyenID) REFERENCES Truyen(ID) ON DELETE CASCADE
);

-- B·∫£ng T√†i kho·∫£n VIP
CREATE TABLE TaiKhoanVIP (
    ID INT AUTO_INCREMENT PRIMARY KEY,
    NguoiDungID INT,
    NgayBatDau DATETIME NOT NULL,
    NgayKetThuc DATETIME NOT NULL,
    LoaiVIP VARCHAR(50) DEFAULT 'THANG',
    GiaVIP DECIMAL(18,2),
    TrangThai BOOLEAN DEFAULT TRUE,
    NgayTao DATETIME DEFAULT CURRENT_TIMESTAMP,
    CHECK (LoaiVIP IN ('THANG', 'NAM', 'VINH_VIEN')),
    FOREIGN KEY (NguoiDungID) REFERENCES NguoiDung(ID) ON DELETE CASCADE
);

-- B·∫£ng B√¨nh lu·∫≠n
CREATE TABLE BinhLuan (
    ID INT AUTO_INCREMENT PRIMARY KEY,
    NguoiDungID INT,
    TruyenID INT,
    ChuongID INT NULL,
    NoiDung LONGTEXT NOT NULL,
    TrangThai BOOLEAN DEFAULT TRUE,
    NgayTao DATETIME DEFAULT CURRENT_TIMESTAMP,
    BinhLuanChaID INT NULL,
    FOREIGN KEY (NguoiDungID) REFERENCES NguoiDung(ID) ON DELETE NO ACTION,
    FOREIGN KEY (TruyenID) REFERENCES Truyen(ID) ON DELETE CASCADE,
    FOREIGN KEY (ChuongID) REFERENCES Chuong(ID) ON DELETE NO ACTION,
    FOREIGN KEY (BinhLuanChaID) REFERENCES BinhLuan(ID) ON DELETE NO ACTION
);

-- B·∫£ng T·ªß truy·ªán
CREATE TABLE TuTruyen (
    ID INT AUTO_INCREMENT PRIMARY KEY,
    NguoiDungID INT,
    TruyenID INT,
    NgayLuu DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY (NguoiDungID, TruyenID),
    FOREIGN KEY (NguoiDungID) REFERENCES NguoiDung(ID) ON DELETE CASCADE,
    FOREIGN KEY (TruyenID) REFERENCES Truyen(ID) ON DELETE NO ACTION
);

-- B·∫£ng L·ªãch s·ª≠ ƒë·ªçc
CREATE TABLE LichSuDoc (
    ID INT AUTO_INCREMENT PRIMARY KEY,
    NguoiDungID INT,
    TruyenID INT,
    ChuongID INT,
    NgayDoc DATETIME DEFAULT CURRENT_TIMESTAMP,
    SoLanDoc INT DEFAULT 1,
    FOREIGN KEY (NguoiDungID) REFERENCES NguoiDung(ID) ON DELETE CASCADE,
    FOREIGN KEY (TruyenID) REFERENCES Truyen(ID) ON DELETE NO ACTION,
    FOREIGN KEY (ChuongID) REFERENCES Chuong(ID) ON DELETE NO ACTION
);

-- B·∫£ng ƒê√°nh gi√°
CREATE TABLE DanhGia (
    ID INT AUTO_INCREMENT PRIMARY KEY,
    NguoiDungID INT,
    TruyenID INT,
    DiemSo INT CHECK (DiemSo >= 1 AND DiemSo <= 5),
    NhanXet LONGTEXT,
    NgayDanhGia DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY (NguoiDungID, TruyenID),
    FOREIGN KEY (NguoiDungID) REFERENCES NguoiDung(ID) ON DELETE CASCADE,
    FOREIGN KEY (TruyenID) REFERENCES Truyen(ID) ON DELETE NO ACTION
);

-- B·∫£ng Th·ªëng k√™
CREATE TABLE ThongKe (
    ID INT AUTO_INCREMENT PRIMARY KEY,
    TruyenID INT,
    NgayThongKe DATE NOT NULL,
    LuotXem INT DEFAULT 0,
    LuotXemChuong INT DEFAULT 0,
    SoBinhLuan INT DEFAULT 0,
    SoDanhGia INT DEFAULT 0,
    UNIQUE KEY (TruyenID, NgayThongKe),
    FOREIGN KEY (TruyenID) REFERENCES Truyen(ID) ON DELETE NO ACTION
);

-- B·∫£ng Qu·∫£ng c√°o
CREATE TABLE QuangCao (
    ID INT AUTO_INCREMENT PRIMARY KEY,
    TieuDe VARCHAR(255) NOT NULL,
    NoiDung LONGTEXT,
    AnhQuangCao VARCHAR(500),
    LinkQuangCao VARCHAR(500),
    ViTri VARCHAR(100),
    NgayBatDau DATETIME NOT NULL,
    NgayKetThuc DATETIME NOT NULL,
    TrangThai BOOLEAN DEFAULT TRUE,
    ThuTu INT DEFAULT 0,
    NgayTao DATETIME DEFAULT CURRENT_TIMESTAMP,
    CHECK (ViTri IN ('HEADER', 'SIDEBAR', 'FOOTER', 'GIUA_CHUONG', 'POPUP'))
);

-- B·∫£ng Th√¥ng b√°o
CREATE TABLE ThongBao (
    ID INT AUTO_INCREMENT PRIMARY KEY,
    NguoiDungID INT,
    TieuDe VARCHAR(255) NOT NULL,
    NoiDung LONGTEXT NOT NULL,
    LoaiThongBao VARCHAR(50),
    DaDoc BOOLEAN DEFAULT FALSE,
    NgayTao DATETIME DEFAULT CURRENT_TIMESTAMP,
    LinkChuyenHuong LONGTEXT NULL,
    CHECK (LoaiThongBao IN ('CHUONG_MOI', 'BINH_LUAN', 'VIP', 'HE_THONG')),
    FOREIGN KEY (NguoiDungID) REFERENCES NguoiDung(ID) ON DELETE CASCADE
);

-- B·∫£ng C·∫•u h√¨nh h·ªá th·ªëng
CREATE TABLE CauHinh (
    ID INT AUTO_INCREMENT PRIMARY KEY,
    TenCauHinh VARCHAR(255) NOT NULL UNIQUE,
    GiaTri LONGTEXT,
    MoTa LONGTEXT,
    NgayCapNhat DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- B·∫£ng G√≥i VIP
CREATE TABLE GoiVIP (
    ID INT AUTO_INCREMENT PRIMARY KEY,
    TenGoi VARCHAR(255) NOT NULL,
    MoTa LONGTEXT,
    SoThang INT NOT NULL,
    Gia DECIMAL(18,2) NOT NULL,
    GiaGoc DECIMAL(18,2) NULL,
    PhanTramGiamGia INT DEFAULT 0,
    MauSac VARCHAR(50) DEFAULT '#ffd700',
    Icon VARCHAR(100) DEFAULT 'fas fa-crown',
    TrangThai BOOLEAN DEFAULT TRUE,
    ThuTu INT DEFAULT 0,
    NoiBat BOOLEAN DEFAULT FALSE,
    NgayTao DATETIME DEFAULT CURRENT_TIMESTAMP,
    NgayCapNhat DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- C·∫≠p nh·∫≠t tr·∫°ng th√°i VIP cho ng∆∞·ªùi d√πng ID=1 (v√≠ d·ª•)

-- B·∫°n c√≥ th·ªÉ vi·∫øt th·ªß t·ª•c l∆∞u tr·ªØ ho·∫∑c script b√™n ·ª©ng d·ª•ng ƒë·ªÉ c·∫≠p nh·∫≠t.
-- MySQL kh√¥ng h·ªó tr·ª£ BEGIN TRY...CATCH nh∆∞ SQL Server.
-- V√≠ d·ª• ƒë∆°n gi·∫£n:
UPDATE NguoiDung nd
JOIN TaiKhoanVIP vip ON nd.ID = vip.NguoiDungID
SET nd.TrangThaiVIP = TRUE,
    nd.NgayDangKyVIP = vip.NgayBatDau,
    nd.NgayHetHanVIP = vip.NgayKetThuc,
    nd.NgayCapNhat = NOW()
WHERE vip.TrangThai = TRUE AND vip.NgayKetThuc > NOW()
AND nd.ID = 1;

select from NguoiDung

DELIMITER $$

DROP PROCEDURE IF EXISTS UpdateVIP30Nam$$
CREATE PROCEDURE UpdateVIP30Nam()
BEGIN
    DECLARE v_exists INT DEFAULT 0;
    DECLARE v_GoiVIPID INT;
    DECLARE v_GiaVIP DECIMAL(18,2);
    DECLARE v_NgayBatDau DATETIME;
    DECLARE v_NgayKetThuc DATETIME;

    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        SELECT 'L·ªói khi c·∫≠p nh·∫≠t VIP' AS Message;
    END;

    -- Ki·ªÉm tra t·ªìn t·∫°i ng∆∞·ªùi d√πng ID=1
    SELECT COUNT(*) INTO v_exists FROM NguoiDung WHERE ID = 1;

    IF v_exists = 1 THEN
        SET v_NgayBatDau = NOW();
        SET v_NgayKetThuc = DATE_ADD(v_NgayBatDau, INTERVAL 30 YEAR);

        -- L·∫•y ID v√† gi√° c·ªßa g√≥i VIP 30 nƒÉm
        SELECT ID, Gia INTO v_GoiVIPID, v_GiaVIP FROM GoiVIP WHERE TenGoi = 'VIP 30 NƒÉm' LIMIT 1;

        START TRANSACTION;

        -- C·∫≠p nh·∫≠t b·∫£ng NguoiDung
        UPDATE NguoiDung
        SET TrangThaiVIP = 1,
            NgayDangKyVIP = v_NgayBatDau,
            NgayHetHanVIP = v_NgayKetThuc,
            NgayCapNhat = NOW()
        WHERE ID = 1;

        -- Th√™m b·∫£n ghi v√†o b·∫£ng TaiKhoanVIP
        INSERT INTO TaiKhoanVIP (NguoiDungID, NgayBatDau, NgayKetThuc, LoaiVIP, GiaVIP, TrangThai, NgayTao)
        VALUES (1, v_NgayBatDau, v_NgayKetThuc, 'NAM', v_GiaVIP, 1, NOW());

        -- Th√™m th√¥ng b√°o cho ng∆∞·ªùi d√πng
        INSERT INTO ThongBao (NguoiDungID, TieuDe, NoiDung, LoaiThongBao, DaDoc, NgayTao, LinkChuyenHuong)
        VALUES (
            1,
            'üéâ Ch√∫c m·ª´ng! B·∫°n ƒë√£ ƒë∆∞·ª£c n√¢ng c·∫•p VIP 30 nƒÉm!',
            CONCAT(
                'Ch√∫c m·ª´ng b·∫°n ƒë√£ ƒë∆∞·ª£c n√¢ng c·∫•p t√†i kho·∫£n VIP ƒë·∫∑c bi·ªát 30 nƒÉm! Th·ªùi h·∫°n VIP c·ªßa b·∫°n ƒë·∫øn ng√†y ',
                DATE_FORMAT(v_NgayKetThuc, '%d/%m/%Y %H:%i'),
                '. H√£y t·∫≠n h∆∞·ªüng t·∫•t c·∫£ c√°c t√≠nh nƒÉng cao c·∫•p!'
            ),
            'VIP',
            0,
            NOW(),
            '/profile/vip'
        );

        COMMIT;

        SELECT 'ƒê√£ c·∫≠p nh·∫≠t VIP 30 nƒÉm th√†nh c√¥ng cho ng∆∞·ªùi d√πng ID = 1' AS Message,
               DATE_FORMAT(v_NgayBatDau, '%d/%m/%Y %H:%i') AS NgayBatDau,
               DATE_FORMAT(v_NgayKetThuc, '%d/%m/%Y %H:%i') AS NgayKetThuc;

    ELSE
        SELECT 'Ng∆∞·ªùi d√πng ID = 1 kh√¥ng t·ªìn t·∫°i!' AS Message;
    END IF;
END$$

DELIMITER ;

use dbTruyen
-- G·ªçi th·ªß t·ª•c:
CALL UpdateVIP30Nam();


CREATE TABLE YeuCauThanhToan (
    ID INT AUTO_INCREMENT PRIMARY KEY,
    NguoiDungID INT NOT NULL,
    GoiVIPID INT NOT NULL,
    SoTien DECIMAL(18,2) NOT NULL,
    NoiDungChuyenKhoan VARCHAR(500) NOT NULL,
    TrangThai ENUM('PENDING', 'APPROVED', 'REJECTED') DEFAULT 'PENDING',
    NgayTao DATETIME DEFAULT CURRENT_TIMESTAMP,
    NgayXuLy DATETIME NULL,
    NguoiXuLy INT NULL,
    GhiChu LONGTEXT NULL,
    FOREIGN KEY (NguoiDungID) REFERENCES NguoiDung(ID) ON DELETE CASCADE,
    FOREIGN KEY (GoiVIPID) REFERENCES GoiVIP(ID) ON DELETE CASCADE,
    FOREIGN KEY (NguoiXuLy) REFERENCES NguoiDung(ID) ON DELETE SET NULL
);



-- Script ƒë·ªÉ t·∫°o b·∫£ng YeuThich cho ch·ª©c nƒÉng y√™u th√≠ch truy·ªán
-- Ch·∫°y script n√†y ƒë·ªÉ th√™m b·∫£ng v√†o database

USE DBTruyen;

-- B·∫£ng Y√™u th√≠ch truy·ªán
CREATE TABLE IF NOT EXISTS YeuThich (
    ID INT AUTO_INCREMENT PRIMARY KEY,
    NguoiDungID INT NOT NULL,
    TruyenID INT NOT NULL,
    NgayYeuThich DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY (NguoiDungID, TruyenID),
    FOREIGN KEY (NguoiDungID) REFERENCES NguoiDung(ID) ON DELETE CASCADE,
    FOREIGN KEY (TruyenID) REFERENCES Truyen(ID) ON DELETE NO ACTION
);

-- T·∫°o index ƒë·ªÉ t·ªëi ∆∞u truy v·∫•n
CREATE INDEX idx_yeuthich_nguoidung ON YeuThich(NguoiDungID);
CREATE INDEX idx_yeuthich_truyen ON YeuThich(TruyenID);
CREATE INDEX idx_yeuthich_ngay ON YeuThich(NgayYeuThich DESC);

 